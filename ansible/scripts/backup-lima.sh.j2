#!/usr/bin/env bash
RETENTION_DAYS=90

set -e

case $1 in
  "create")
    docker compose exec -T mariadb sh -c "find /backup -mtime +$RETENTION_DAYS -type f -name 'lima-db-*.sql.gz' -delete"
    docker compose exec -T api sh -c "find /backup -mtime +$RETENTION_DAYS -type f -name 'lima-logos-*.tar.gz' -delete"
    TIMESTAMP=$(date +%Y-%m-%d-%H-%M-%S)
    docker compose exec -T mariadb sh -c "mysqldump --single-transaction lima | gzip > /backup/lima-db-$TIMESTAMP.sql.gz"
    docker compose exec -T api sh -c "cd /var/www/logos && tar -czf /backup/lima-logos-$TIMESTAMP.tar.gz ."
    echo "Backup $TIMESTAMP has been created."
    ;;
  "list")
    docker compose exec mariadb sh -c "cd /backup && ls -lh lima-db-*.sql.gz 2> /dev/null"
    docker compose exec mariadb sh -c "cd /backup && ls -lh lima-logos-*.tar.gz 2> /dev/null"
    ;;
  "restore")
    TIMESTAMP=$2
    docker compose exec -T mariadb sh -c "zcat /backup/lima-db-$TIMESTAMP.sql.gz | mysql lima"
    docker compose exec -T api sh -c "cd /var/www/logos && tar -xzf /backup/lima-logos-$TIMESTAMP.tar.gz"
    echo "Backup $TIMESTAMP has been restored."
    ;;
  *)
    echo "Usage:"
    echo "$0 create"
    echo "$0 list"
    echo "$0 restore <timestamp>"
    ;;
esac
